
- hosts: localhost

  collections:
  - netfoundry.platform

  tasks:
  - name: Establish session and find Network resources
    netfoundry_info:
        network: BibbidiBobbidiBoo
        credentials: credentials.json
    register: netfoundry_info

  - name: declare Endpoints
    netfoundry_endpoint:
        name: "{{ item }}"
        network: "{{ netfoundry_info.network }}"
        attributes:
        - "#workFromAnywhere"
        dest: /tmp/netfoundry                  # filename is Endpoint name if dest is a directory
        #dest: /tmp/netfoundry/ott-{{item}}.jwt # custom filename if name is like *.jwt
    loop:
    - Client1
    - Exit1
    register: endpoints

  - name: declare an Endpoint-hosted Service
    netfoundry_service:
        network: "{{ netfoundry_info.network }}"
        name: HTTP Echo 1
        endpoints: 
        - Exit1
        attributes: 
        - "#welcomeWagon"
        clientHostName: echo-exit.netfoundry
        clientPortRange: 80
        serverHostName: eth0.me
        serverPortRange: 80
        serverProtocol: TCP

  - name: declare a NetFoundry-datacenter-hosted Edge Router
    netfoundry_router:
        network: "{{ netfoundry_info.network }}"
        name: Oregon Router
        attributes: 
        - "#defaultRouters"
        datacenter: us-west-2
    register: hosted_router

  - name: declare a blanket Edge Router Policy
    netfoundry_router_policy:
        network: "{{ netfoundry_info.network }}"
        name: defaultRouters
        routers:
        - "#defaultRouters"
        endpoints:
        - "#all"
    register: blanket_policy

  - name: declare a Router-hosted Service
    netfoundry_service:
        network: "{{ netfoundry_info.network }}"
        name: HTTP Echo 2
        attributes: 
        - "#welcomeWagon"
        clientHostName: echo2.netfoundry
        clientPortRange: 80
        egressRouter: "{{ hosted_router.message.id }}"
        serverHostName: eth0.me
        serverPortRange: 80
        serverProtocol: TCP

  - name: declare an AppWAN
    netfoundry_appwan:
        network: "{{ netfoundry_info.network }}"
        name: Welcome
        endpoints:
        - "#workFromAnywhere"
        services:
        - "#welcomeWagon"
    
    


